---
title: "Projekt"
author: "Luka Kovačević, Bruno Pleše, Lucija Prodan, Dominik Topić"
date: "15.12.2025."
output:
  word_document: default
  pdf_document: default
subtitle: Case study *Predikcija moždanog udara*
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Motivacija i opis problema

Moždani udar jedna je od vodećih uzroka smrti i invaliditeta širom svijeta. Prema podacima Svjetske zdravstvene organizacije (WHO), moždani udar odgovoran je za približno 11% svih smrtnih slučajeva globalno. Rana identifikacija osoba s visokim rizikom od moždanog udara ključna je za pravovremenu intervenciju i prevenciju. 

Suvremeni pristupi u medicini sve više koriste statističke metode i strojno učenje za analizu zdravstvenih podataka kako bi se identificirali čimbenici rizika i razvili prediktivni modeli. Ovaj projekt fokusira se na analizu kliničkih podataka pacijenata s ciljem razumijevanja čimbenika koji doprinose riziku od moždanog udara. 

## Case study: *Predikcija moždanog udara*
Interpretacija podataka značajan je dio obrade podataka. Stoga je bitno znati kontekst podataka i upoznati se s datasetom. 

```{r}
stroke_data = read.csv("healthcare-dataset-stroke-data.csv")
dim(stroke_data)

```

```{r}
head(stroke_data)
```

## Osnovna deskriptivna statistika
Cilj deskriptivne statistike je opisivanje, sažimanje i interpretacija podataka na način koji olakšava razumijevanje njihovih osnovnih obilježja, ali ne daje nikakve zaključke o uzrocima ili posljedicama.  

```{r}
# Osnovna deskriptivna statistika:
summary(stroke_data)
```
Naredba summary() koristi se za brz pregled osnovnih statističkih karakteristika podataka (raspon, medijan, prosjek i kvartile).

Skup podataka sadrži 5110 pacijenata. Dob pacijenata kreće se od 0.08 do 82 godine, s prosječnom dobi od 43.23 godine i medijanom od 45 godina. Većina pacijenata nema hipertenziju ni srčane bolesti, što je vidljivo iz niskih prosječnih vrijednosti binarnih varijabli hypertension (9.7%) i heart_disease (5.4%).

Prosječna razina glukoze iznosi 106.15 mg/dL, pri čemu su prisutne izrazito visoke maksimalne vrijednosti, što upućuje na asimetričnu distribuciju. Ciljna varijabla stroke ima prosječnu vrijednost 0.0487, što znači da je oko 4.9% pacijenata doživjelo moždani udar, pa je skup podataka neuravnotežen.

Kategorijske varijable su učitane kao tip character, što zahtijeva njihovu konverziju u faktore prije daljnje analize.

```{r}
stroke_data$gender <- as.factor(stroke_data$gender)
stroke_data$ever_married <- as.factor(stroke_data$ever_married)
stroke_data$work_type <- as.factor(stroke_data$work_type)
stroke_data$Residence_type <- as.factor(stroke_data$Residence_type)
stroke_data$smoking_status <- as.factor(stroke_data$smoking_status)
stroke_data$stroke <- as.factor(stroke_data$stroke)

```

```{r}
lapply(stroke_data[, sapply(stroke_data, is.factor)], table)
```
Naredba table() koristi se za prikaz frekvencija kategorijskih varijabli.

U uzorku prevladavaju žene (2994) u odnosu na muškarce (2115), dok je kategorija Other zanemariva. Većina pacijenata je u braku (3353), a najzastupljeniji tip zaposlenja je Private sektor (2925), dok je najmanje pacijenata koji nikada nisu radili.

Distribucija prebivališta je gotovo ravnomjerna između urbanih (2596) i ruralnih (2514) područja. Kod statusa pušenja najčešća je kategorija never smoked (1892), dok je značajan udio pacijenata s nepoznatim statusom pušenja (1544), što može utjecati na daljnju analizu.


```{r}
table(stroke_data$stroke)
prop.table(table(stroke_data$stroke)) * 100
```
Ciljna varijabla stroke pokazuje izrazitu neuravnoteženost, s velikom većinom pacijenata bez moždanog udara (4861) u odnosu na one koji su ga doživjeli (249).

## Vizualizacija podataka

Vizualizacija podataka proces je prikazivanja informacija pomoću grafičkih ili slikovnih elemenata kako bi se olakšalo razumijevanje, analiza i interpretacija podataka.  

```{r}
barplot(
  table(stroke_data$stroke),
  col = c("lightblue", "tomato"),
  main = "Distribucija moždanog udara",
  xlab = "Stroke",
  ylab = "Broj pacijenata"
)

```
Bar graf prikazuje raspodjelu ciljne varijable stroke. Vidljivo je da velika većina pacijenata nije doživjela moždani udar (vrijednost 0), dok je broj pacijenata s moždanim udarom (vrijednost 1) znatno manji. Ovakva raspodjela potvrđuje da je skup podataka izraženo neuravnotežen, što je važno uzeti u obzir u daljnjoj statističkoj analizi i modeliranju.


```{r}
hist(
  stroke_data$age,
  breaks = 30,
  col = "lightgray",
  main = "Distribucija dobi pacijenata",
  xlab = "Dob"
)
```

Histogram se koristi za prikaz raspodjele numeričke varijable. Distribucija dobi pokazuje da su u uzorku zastupljene sve dobne skupine, s najvećim brojem pacijenata u srednjim i starijim dobnim skupinama. Raspon dobi je širok, što omogućuje analizu utjecaja dobi na pojavu moždanog udara.

```{r}
hist(
  stroke_data$avg_glucose_level,
  breaks = 30,
  col = "lightgray",
  main = "Distribucija razine glukoze",
  xlab = "Prosječna razina glukoze (mg/dL)"
)
```
Histogram se koristi za uvid u raspodjelu numeričke varijable. Distribucija prosječne razine glukoze je asimetrična (pozitivno nagnuta), pri čemu većina pacijenata ima vrijednosti između približno 70 i 110 mg/dL, dok manji broj pacijenata ima izrazito povišene razine glukoze. To upućuje na prisutnost potencijalnih rizičnih skupina za moždani udar.

```{r}
hist(
  stroke_data$bmi,
  breaks = 30,
  col = "lightgray",
  main = "Distribucija BMI-ja",
  xlab = "BMI"
)
```
Distribucija BMI-ja je asimetrična s desnim repom, pri čemu se većina vrijednosti nalazi između približno 20 i 35. Prisutne su i ekstremno visoke vrijednosti BMI-ja, što može upućivati na potencijalne stršeće vrijednosti koje je potrebno uzeti u obzir u daljnjoj analizi. Za sada ih nije potrebno uklanjati jer predstavljaju realne, iako rijetke, medicinske slučajeve te mogu biti relevantne za analizu moždanog udara.

## Čišćenje podataka

Moguće je da u podatcima nedostaju neke vrijednosti, koje u učitanom dataframe-u poprimaju vrijednost `N/A`. 

Kako ćemo tretirati nedostajuće vrijednosti ovisit će prvenstveno o samom datasetu, odnosno kontekstu podataka. 

```{r}
colSums(is.na(stroke_data))
```
Naredba colSums(is.na()) koristi se za utvrđivanje broja nedostajućih vrijednosti po varijabli.

```{r}
table(stroke_data$bmi)
```

```{r}
stroke_data$bmi[stroke_data$bmi == "N/A"] <- NA
stroke_data$bmi <- as.numeric(stroke_data$bmi)
```


```{r}
colSums(is.na(stroke_data))
```
Iako je u početnom prikazu izgledalo da nema nedostajućih vrijednosti, varijabla bmi sadržavala je vrijednosti "N/A" učitane kao znakovni tip podataka, koje R ne prepoznaje kao stvarne nedostajuće vrijednosti. Nakon konverzije "N/A" u NA, utvrđeno je da varijabla bmi sadrži 201 nedostajuću vrijednost.

```{r}
#Stvaramo kopiju podataka za uporabu za imputaciju
imp_data <- stroke_data

#Izrađujemo regresijski model za predviđanje bmi vrijednosti
bmi_imp_model <- lm(bmi ~ age + gender + avg_glucose_level + heart_disease + hypertension,
                    data = imp_data,
                    na.action = na.exclude)

#Dobivamo predviđene vrijednosti
bmi_pred <- predict(bmi_imp_model, newdata = imp_data)

#Tražimo devijaciju residuala kako bismo implementirali varijaciju u predviđanja
res_sd <- sd(residuals(bmi_imp_model), na.rm = TRUE)

#Za usporedbu stvaramo dodatni stupac za nove vrijednosti
imp_data$bmi_imp <- imp_data$bmi

#Upisujemo predviđene vrijednosti i dodajemo stohastičku komponentu
imp_data$bmi_imp[is.na(imp_data$bmi)] <- bmi_pred[is.na(imp_data$bmi)] + rnorm(sum(is.na(imp_data$bmi)), 0, res_sd)

#Prikaz razlike BMI-ja prije i poslije imputacije
par(mfrow = c(1,2))
hist(imp_data$bmi, main = "Izvorni BMI", col = "gray", xlab = "BMI")
hist(imp_data$bmi_imp, main = "Imputirani BMI", col = "blue", xlab = "BMI")

#Prepisujemo originalne BMI vrijednosti imputiranim
stroke_data$bmi[is.na(stroke_data$bmi)] <- imp_data$bmi_imp[is.na(stroke_data$bmi)]
```

Odabrali smo stohastičku regresijsku imputaciju jer velik udio N/A vrijednosti se nalazio među pacijentima s moždanim udarom što bi moglo značajno utjecati na testove koji uključuju ovaj čimbenik pošto je udio pacijenata s moždanim udarom već sam po sebi nizak. Ova imputacija zadržava relativne odnose među čimbenicima te uključuje i varijabilnu komponentu pomoću residuala regresije.

## 1. pitanje: Postoji li statistički značajna razlika u prosječnoj razini glukoze između pacijenata sa i bez moždanog udara?

```{r}
t_test_glucose <- t.test(
  avg_glucose_level ~ stroke,
  data = stroke_data
)

t_test_glucose
```

Za ispitivanje razlike u prosječnoj razini glukoze između pacijenata sa i bez moždanog udara korišten je Welchov t-test, jer su skupine nejednake veličine i ne pretpostavlja se jednakost varijanci. Rezultati pokazuju da je razlika statistički značajna (p = 2.4 × 10⁻¹¹). Pacijenti koji su doživjeli moždani udar imaju višu prosječnu razinu glukoze (132.5 mg/dL) u usporedbi s pacijentima bez moždanog udara (104.8 mg/dL). Time se odbacuje nul-hipoteza i zaključuje da je razina glukoze povezana s pojavom moždanog udara. 

To možemo i vizualno prikazati.

```{r}
boxplot(
  avg_glucose_level ~ stroke,
  data = stroke_data,
  col = c("lightblue", "tomato"),
  main = "Razine glukoze prema moždanom udaru",
  xlab = "Stroke",
  ylab = "Prosječna razina glukoze (mg/dL)"
)
```

Vidljivo je da pacijenti koji su doživjeli moždani udar imaju višu medijanu i veći raspon vrijednosti glukoze u odnosu na pacijente bez moždanog udara. Ova vizualizacija potvrđuje rezultat Welchovog t-testa koji je pokazao statistički značajnu razliku u prosječnoj razini glukoze između skupina.

Velik broj stršećih vrijednosti posljedica je asimetrične distribucije razine glukoze i velikog uzorka, a ne pogrešaka u podacima, stoga nisu uklonjene iz analize.


```{r}
hist(
  stroke_data$avg_glucose_level[stroke_data$stroke == 0],
  breaks = 30,
  col = rgb(0, 0, 1, 0.5),
  xlim = c(50, 300),
  main = "Distribucija glukoze po moždanom udaru",
  xlab = "Prosječna razina glukoze (mg/dL)"
)

hist(
  stroke_data$avg_glucose_level[stroke_data$stroke == 1],
  breaks = 30,
  col = rgb(1, 0, 0, 0.5),
  add = TRUE
)

legend(
  "topright",
  legend = c("Bez moždanog udara", "Moždani udar"),
  fill = c(rgb(0,0,1,0.5), rgb(1,0,0,0.5))
)
```

Vidljivo je da je distribucija za pacijente s moždanim udarom pomaknuta prema višim vrijednostima glukoze, dok pacijenti bez moždanog udara češće imaju niže i srednje vrijednosti. Ova vizualizacija dodatno potvrđuje statistički značajnu razliku u prosječnoj razini glukoze između skupina.

## 3. Pitanje: Koji čimbenici najbolje predviđaju nastanak moždanog udara kada razmatramo dob, razinu glukoze, BMI i hipertenziju?

Kako je potrebno usporediti utjecaj više nezavisnih varijabli na zavisnu, ovdje ćemo provesti logističku regresiju. Razlog zašto koristimo logističku, a ne linearnu regresiju je što nam je zavisna varijabla (reakcija) u binarnom obliku.

Prije provedbe regresije potrebno je uvjeriti se da su podaci ispravno prilagođeni, logistička regresija ne zahtjeva normalnu razdiobu, ali je nužan linearni odnos numeričkih vrijednosti s log-izgledom moždanog udara. To ćemo pokazati grafički za dob, razinu glukoze i BMI.

```{r} 
library(dplyr)
library(ggplot2)

plotdata <- stroke_data

plotfunc <- function(var, plotdata) {
  plotdata <- plotdata %>%
    mutate(var_decile = ntile({{var}}, 10)) %>%
    group_by(var_decile) %>%
    summarise(mean_var = mean({{var}}), p_stroke = mean(as.integer(as.character(stroke)))) %>%
    mutate(log_odds = log((p_stroke + 0.001) / (1 - p_stroke + 0.001)))
  ggplot(plotdata, aes(x = mean_var, y = log_odds)) + 
    geom_point(size = 3, color = "blue") + 
    geom_smooth(method = "lm", se = FALSE, color = "red") + 
    labs(
      x = paste("Središnja vrijednost", deparse(substitute(var)), "po decilu"),
      y = "Log-izgled moždanog udara",
      title = paste("Grafička provjera linearnosti",  deparse(substitute(var)), "u log-izgled skali")
    ) + 
    theme_minimal()
}

plotfunc(age, plotdata)
plotfunc(avg_glucose_level, plotdata)
plotfunc(bmi, plotdata)
```

Vidimo da za sva tri atributa se podaci većinom slažu s pravcem, to ukazuje na traženu linearnu vezu. Odstupanja su većinom na prvim i zadnjim točkama što je očekivano, kod BMI-ja uočavamo nešto veća odstupanja, ali još uvijek unutar očekivanja.

Za hipertenziju nije potrebna ovakva provjera jer je varijabla binarna pa je podjela u decile besmislena te je linearnost pretpostavljena.

Provodimo logističku regresiju s logit vezom nad varijablama dob, razina glukoze, BMI i hipertenzija.

```{r} 
#Pretvorba stroke u brojevni tip
reg_data <- stroke_data
reg_data$stroke <- as.integer(as.character(reg_data$stroke))

#Kreiranje modela
model <- glm(stroke ~ age + avg_glucose_level + bmi + hypertension,
             data = reg_data,
             family = binomial)

#Pregled rezultata
summary(model)
exp(coef(model))
```

Regresija pokazuje da su vrijednosti glukoze i dob imali najznačajniji utjecaj. Hipertenzija je također bila značajna, no ne na istoj razini. BMI jedini nema značajni utjecaj.

Konačno, vidimo koeficijente eksponirane za lakše razumijevanje, gledajući u ispis summary-a, povećanje svakog atributa za 1 očituje se zbrajanjem pripadne vrijednosti na log-izgled, eksponiranjem dobijemo jasniju metriku, vrijedi npr. da ako povećamo dob za 1 će se vjerojatnost moždanog udara za pripadnu vrijednost umnožiti.

No ne znamo još da je ovaj model ispravan. Provest ćemo LR test kako bismo to utvrdili, postavljamo hipoteze
H0: niti jedan od odabranih atributa (dob, razina glukoze, BMI, hipertenzija) ne utječe na pojavu moždanog udara
H1: barem jedan od odabranih atributa ima značajan utjecaj na izgled pojavu moždanog udara

LR test ćemo provesti uspoređujući dobiveni model s "null" modelom, null model sadrži samo slobodni koeficijent, odnosno ne ovisi niti o jednom atributu podataka osim zavisne varijable.

```{r}
null_model <- glm(stroke ~ 1,
                  data = reg_data,
                  family = binomial)

anova(null_model, model, test = "Chisq")
```

Vidimo iz rezultata da je p-vrijednost manja od 0.001 što nam daje izrazitu značajnost i znači da možemo odbaciti nultu hipotezu. Dakle zaključili smo da je ovaj model valjan na visokoj razini značajnosti tj. da je barem jedan od ovih faktora imao veliki utjecaj na izgled pojave moždanog udara.

Sada možemo prijeći na glavno pitanje, koji od ovih čimbenika najbolje predviđa pojavu moždanog udara?

Najlakše ćemo to utvrdit usporedbom omjera izglednosti nad standardiziranim varijablama. Prvo ćemo dakle ponoviti izradu modela sa sva tri numerička čimbenika standardizirana pa dobivene koeficijente eksponirat i usporedit, onaj s najvećom vrijednosti najbolje predviđa.

```{r}
reg_data <- reg_data %>%
  mutate(
    age_z = (age - mean(age)) / sd(age),
    glucose_z = (avg_glucose_level - mean(avg_glucose_level)) / sd(avg_glucose_level),
    bmi_z = (bmi - mean(bmi)) / sd(bmi)
  )

model_std <- glm(stroke ~ age_z + glucose_z + bmi_z + hypertension,
             data = reg_data,
             family = binomial)

summary(model_std)

exp(coef(model_std))
```

Ovdje sada jasno vidimo da je najutjecajniji čimbenik dob, za svaku standardnu devijancu od srednje vrijednosti, množimo izglednost moždanog udara za 4.98. Nakon dobi dolazi hipertenzija koja nije standardizirana zbog svoje binarnosti pa se manje precizno ovdje uspoređuje te nakon nje razina glukoze i konačno BMI koji ima vrlo slab utjecaj.

Zaključujemo da je dob čimbenik koji najbolje predviđa nastanak moždanog udara.

## 4. pitanje: Postoji li povezanost između statusa pušenja i nastanka moždanog udara?

Cilj ovog zadatka je ispitati postoji li statistički značajna povezanost između statusa pušenja i pojave moždanog udara. Pušenje je poznati rizični faktor za kardiovaskularne bolesti, stoga je važno provjeriti postoji li povezanost između ove navike i nastanka moždanog udara u promatranom skupu podataka.


### Vizualizacija
Prije provođenja testa, provodimo analizu kako bismo stekli uvid u strukturu podataka i potencijalne obrasce između statusa pušenja i pojave moždanog udara.


```{r}
smoking_freq <- table(stroke_data$smoking_status)
smoking_freq

barplot(
  smoking_freq,
  col = "lightgray",
  main = "Distribucija statusa pušenja",
  xlab = "Status pušenja",
  ylab = "Broj ispitanika"
)


```
Budući da su skupine prema statusu pušenja različitih veličina, rezultati testa mogu biti pod većim utjecajem dominantnih kategorija. Manje skupine mogu imati izraženije razlike u udjelima, ali njihov doprinos testnoj statistici može biti manji. Stoga je uz p-vrijednost važno analizirati i relativne udjele te grafičke prikaze podataka.


```{r}
tab <- table(stroke_data$smoking_status, stroke_data$stroke)

# Udio moždanog udara po kategoriji pušenja
prop_tab <- prop.table(tab, margin = 1)
prop_tab

```

```{r}
barplot(
  prop_tab,
  beside = TRUE,
  col = c("blue", "tomato", "green", "gray"),
  legend = TRUE,
  main = "Udio moždanog udara prema statusu pušenja",
  xlab = "Status pušenja",
  ylab = "Udio"
)
```

Vidljivo je da u svim kategorijama pušenja većinu čine ispitanici bez moždanog udara. Udio moždanog udara razlikuje se između kategorija statusa pušenja. Najviši udio moždanog udara uočava se kod osoba koje su ranije pušile (formerly smoked), dok je najniži udio zabilježen u kategoriji (Unknown).

Ove razlike u udjelima sugeriraju moguću povezanost između statusa pušenja i pojave moždanog udara, no za potvrdu ove pretpostavke potrebno je provesti statistički test.


### Statistički test

Za ispitivanje nezavisnosti varijable pušenja i moždanog udara, koristimo hi-kvadrat test nezavisnosti za kategorijske podatke. Hi-kvadrat test omogućuje ispitivanje hipoteze o nezavisnosti promatranih varijabli, što ga čini prikladnim za analizu statusa pušenja i pojave moždanog udara u ovom skupu podataka.



Za ovaj test postavljamo: 
H0: smoking_status i stroke su nezavisni
H1: smoking_status i stroke su zavisni

Postavljamo razinu značajnosti na 0.5

Prije testa trebamo napraviti kontingencijsku tablicu.

Kontingencijskim tablicama prikazujemo frekvencije uzorka dobivenog mjerenjem dvodimenzionalnog kategorijskog ili diskretnog numeričkog obilježja (X, Y )


```{r}
# Kontingencijska tablica

tbl <- table(
  stroke_data$smoking_status,
  stroke_data$stroke
)

tbl


```
U tablici frekvencija vidimo da je kategorija 'Unknown' prisutna u velikom broju, a ne predstavlja stvarni status pušenja, s toga će mo ju maknuti iz tablice da ne bi loše utjecala na test.

Kopirajmo najprije podatke u novi data.frame kako ne bi promijenili prave vrijednosti.

```{r}
strokeData_copy = data.frame(stroke_data)
```
Kako bi lakše baratali sa varijablom "smoking_status", možemo je pretvoriti u "character" tip podatka.

```{r}
strokeData_copy['smoking_status'] <- sapply(strokeData_copy['smoking_status'], as.character);

```
Izbacimo status 'Unknown' iz tablice

```{r}
tab <- table(strokeData_copy[strokeData_copy$smoking_status == "formerly smoked" | strokeData_copy$smoking_status == "never smoked" | strokeData_copy$smoking_status == "smokes",]$smoking_status, 
            strokeData_copy[strokeData_copy$smoking_status == "formerly smoked" | strokeData_copy$smoking_status == "never smoked" | strokeData_copy$smoking_status == "smokes",]$stroke)
tab
```

```{r}
# Dodamo sume redaka i stupaca
added_margins_tbl = addmargins(tab)
added_margins_tbl
```


Iz tablice je izostavljena kategorija 'Unknown' jer ne predstavlja stvarni status pušenja te može loše utjecati na test.

Pretpostavka testa je da očekivana frekvencija pojedinog razreda mora biti veća ili jednaka 5.

```{r}
for (col_names in colnames(added_margins_tbl)){
  for (row_names in rownames(added_margins_tbl)){
    if (!(row_names == 'Sum' | col_names == 'Sum') ){
      cat('Očekivane frekvencije za razred ',col_names,'-',row_names,': ',(added_margins_tbl[row_names,'Sum'] * added_margins_tbl['Sum',col_names]) / added_margins_tbl['Sum','Sum'],'\n')
    }
  }
}
```
Pošto su sve frekvencije veće od 5, pretpostavka testa je zadovoljena i možemo nastaviti sa testom.

```{r}
# Hi-kvadrat test
test <- chisq.test(tab, correct=F)
test
```


Dobivena p-vrijednost iznosi p = 0.003285. Budući da je p-vrijednost manja od razine značajnosti α = 0.05, odbacujemo nultu hipotezu u korist alternativne hipoteze. Zaključujemo da postoji statistički značajna povezanost između statusa pušenja i pojave moždanog udara.



### Zaključak

Rezultati analize pokazuju da je status pušenja statistički značajno povezan s pojavom moždanog udara u promatranom skupu podataka. Ovaj rezultat u skladu je s medicinskim spoznajama da pušenje povećava
rizik od kardiovaskularnih i cerebrovaskularnih bolesti.

Iako se na temelju ovih podataka ne može zaključiti uzročnost, dobiveni rezultati naglašavaju važnost prestanka pušenja kao preventivne mjere protiv moždanog udara.









